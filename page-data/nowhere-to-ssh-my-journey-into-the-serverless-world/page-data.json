{"componentChunkName":"component---src-templates-post-template-js","path":"/nowhere-to-ssh-my-journey-into-the-serverless-world/","result":{"data":{"markdownRemark":{"id":"0ac56c87-188d-5307-94b1-1e8e5226da35","html":"<blockquote class=\"wp-block-quote\">\n  <p>\n    tl;dr: I migrated a small real-world app from Express + MongoDB to Now + Firebase. I&#8217;m happy I was able to do it in ~10 hours and I don&#8217;t need to maintain or spend money on servers (at least for now).\n  </p>\n</blockquote>\n<p>Since <a href=\"https://twitter.com/jdbothma/status/1100714277185433602\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">I‚Äôm</a> <a href=\"https://twitter.com/erik_mh/status/1181399247763202048\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">terrible</a> <a href=\"https://twitter.com/fcaivano/status/849084831959052288\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">at</a> <a href=\"https://twitter.com/erik_mh/status/1181399247763202048\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"></a><a href=\"https://twitter.com/lu_cyP/status/922346987487449088\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">managing</a> my personal project‚Äôs servers I wanted to believe the hype around Serverless architectures. My intention was to go to a scenario where I don‚Äôt have to worry about scalability, OS vulnerabilities, web servers, SSL certificates or database backups. Time will tell but for now it seems that‚Äôs the case.</p>\n<h2 id=\"the-state-where-i-was-in\"><a href=\"#the-state-where-i-was-in\" aria-label=\"the state where i was in permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The state where I was in</h2>\n<p>To start experimenting with this technology I chose <a href=\"https://gurivr.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GuriVR</a>. It was a Preact app with a tiny Express backend using MongoDB as the primary database, you can explore the old <a href=\"https://github.com/OpenNewsLabs/guri-vr/tree/3f293ea45b421169e6a8559e3d5df49dcab829d4\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">codebase</a>. It was hosted on a $10/month DigitalOcean droplet along with other apps and sites.</p>\n<h2 id=\"changing-the-mindset\"><a href=\"#changing-the-mindset\" aria-label=\"changing the mindset permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Changing the mindset</h2>\n<p>I looked at different platforms and frameworks and decided to give a chance to <a href=\"https://zeit.co\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Now</a> from Zeit, the magic <strong>now</strong> command played an important part in the decision.</p>\n<p>What I understood from the docs is that in the serverless world you get a kind of clean slate on every request. The goal is to return as fast as possible and avoid persistent connection. Firebase was a great fit for my need because it offers two products I needed to implement: Stateless authentication instead of the MongoDB backed user sessions in the old system and the <strong>Firestore</strong> database. One functionality I wasn‚Äôt giving up easily that I got for free in Firebase was the ‚Äúpasswordless‚Äù authentication.</p>\n<p>Besides the database and authentication provider change I haven‚Äôt had to change too much. The Frontend compiles to a static app that <strong>Now</strong> delivers super fast with their Smart CDN. The <strong>Express</strong> app was easy to convert. I just moved each endpoint to a separate file, matching the API structure. For the frontend I used @now/static and for the backend @now/node.</p>\n<p>Most of the ~10 hours I had to work on the migration where spent implementing the new firebase authentication and updating the database calls to use Firestore. I also moved the file uploads from AWS S3 to the Firestore Storage service just because I thought it was better to have all the services in the same provider and dashboard ¬Ø_(„ÉÑ)_/¬Ø.</p>\n<h2 id=\"platform-specific-configuration\"><a href=\"#platform-specific-configuration\" aria-label=\"platform specific configuration permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Platform specific configuration</h2>\n<p>Besides moving the backend endpoints to different files exporting the lambda functions I had to create a now.json file to hep <strong>Now</strong> figure out how my project should be deployed. This was the first time I did this and I‚Äôm sure there are better ways to do it but this is what I got:</p>\n<pre class=\"wp-block-code\"><code>{\n  \"version\": 2,\n  \"name\": \"gurivr\",\n  \"builds\": [\n    { \"src\": \"api/**\", \"use\": \"@now/node\" },\n    { \"src\": \"client/dist/**\", \"use\": \"@now/static\" }\n  ],\n  \"routes\": [\n    { \"src\": \"/api/preview\", \"dest\": \"api/preview.js\" },\n    { \"src\": \"/api/stories\", \"dest\": \"api/stories.js\" },\n    { \"src\": \"/api/stories/([^/]+)\", \"dest\": \"api/story.js?id=$1\" },\n    { \"src\": \"/api/assets/search\", \"dest\": \"api/assets/search.js\", \"headers\": { \"Access-Control-Allow-Origin\": \"*\" } },\n    { \"src\": \"/(login|guide|stories)\", \"dest\": \"/client/dist/index.html\" },\n    { \"src\": \"/stories/create\", \"dest\": \"/client/dist/index.html\" },\n    { \"src\": \"/(.*)\", \"dest\": \"/client/dist/$1\" }\n  ],\n  \"env\": {\n    \"FIREBASE_ADMIN\": \"@firebase-admin\",\n    \"FLICKR_SECRET_KEY\": \"@flickr-secret-key\",\n    \"GMAPS_SECRET_KEY\": \"@gmaps-secret-key\",\n    \"FREESOUND_SECRET_KEY\": \"@freesound-secret-key\",\n    \"STORAGE_BUCKET\": \"@storage-bucket\"\n  }\n}</code></pre>\n<p>This was maybe the trickiest part of the project but it wasn‚Äôt that hard to be honest. The development phase was a delight. To start a local server I just typed <strong>now dev</strong> and that was it. The node.js backend and the frontend were up in about one second. It also offers live-reload, something that I wasn‚Äôt even expecting üòç. On development mode you can set a <em>.env</em> file to provide environment variables and secrets.</p>\n<p>Every time I wanted to see if everything worked well ‚Äúin the internets‚Äù I just used the <strong>now</strong> command that returns a nice development url for every deploy.</p>\n<h2 id=\"the-deployment\"><a href=\"#the-deployment\" aria-label=\"the deployment permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The ‚Äúdeployment‚Äù</h2>\n<p>This felt like cheating. For deploying to production I had to do 2 things. The first one was setting up the secrets using the <strong>now</strong> tool. This means typing <strong>now secrets add my-secret ‚Äô42‚Äô</strong>. Then, to get a production build I executed again the <strong>now</strong> command but with the <strong>‚Äìprod</strong> flag, and that was it (I promise).</p>\n<h2 id=\"whats-next\"><a href=\"#whats-next\" aria-label=\"whats next permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What‚Äôs next?</h2>\n<p>You can see the <a href=\"https://github.com/OpenNewsLabs/guri-vr/commit/b8fe814c90f601679cf32fe022280f3bbf77d3a1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">diff</a> on the codebase and get your own conclusion. My next move will be to figure out how to move this blog and my other projects to this schema. You can reach me on <a href=\"https://twitter.com/impronunciable\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">twitter</a> if you have questions or want to add something to the discussion.</p>","fields":{"slug":"/nowhere-to-ssh-my-journey-into-the-serverless-world/","tagSlugs":["/tag/serverless/","/tag/gurivr/","/tag/firebase/","/tag/zeit/"]},"frontmatter":{"date":"2019-10-09T16:23:35-05:00","description":"I migrated a small real-world app from Express + MongoDB to Now + Firebase. I'm happy I was able to do it in ~10 hours and I don&#8217;t need to maintain or spend money on servers (at least for now).","tags":["serverless","gurivr","firebase","zeit"],"title":"Nowhere to SSH: my journey into the Serverless world","socialImage":"/photo.jpg"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/nowhere-to-ssh-my-journey-into-the-serverless-world/"}}}